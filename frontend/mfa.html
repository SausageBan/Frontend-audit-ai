<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MFA Verification | AuditAI</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="assets/style.css">

<style>
    .qr-box {
        display:flex;justify-content:center;align-items:center;
        background:#f8f9fa;border-radius:10px;padding:15px;
        border:1px solid #ddd;
    }
</style>
</head>

<body class="d-flex justify-content-center align-items-center vh-100">

<div class="card p-4 shadow" style="width:430px">
    <h3 class="text-center text-primary fw-bold">Multi-Factor Authentication</h3>
    <p class="text-center text-muted mb-3">Scan the QR using Google Authenticator / Authy</p>

    <div id="qr-container" class="qr-box mb-3">
        <span class="text-muted">Loading QR...</span>
    </div>

    <div class="form-floating mb-3">
        <input type="text" id="otpInput" class="form-control" placeholder="123456" maxlength="6">
        <label>Enter 6-digit OTP</label>
    </div>

    <button id="verifyBtn" class="btn btn-success w-100 fw-bold">Verify & Continue</button>
    <p id="msg" class="text-center mt-2 fw-semibold"></p>
</div>

<script>
const token = sessionStorage.getItem("mfa_token");  // must be stored from login
const API_BASE = "https://your-backend-url.com";    // <--- replace

// Load QR on page ready
document.addEventListener("DOMContentLoaded", async () => {
    if(!token){
        document.getElementById("msg").innerHTML = "⚠ No MFA session token found.";
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/auth/mfa/setup?token=${token}`);
        const data = await res.json();

        if(data.qr){
            document.getElementById("qr-container").innerHTML =
                `<img src="${data.qr}" width="260" alt="MFA QR Code">`;
        } else {
            document.getElementById("qr-container").innerHTML =
                `<span class="text-danger">QR unavailable — backend issue</span>`;
        }
    } catch (err) {
        document.getElementById("qr-container").innerHTML =
            `<span class="text-danger">Error loading QR</span>`;
    }
});

// VERIFY BUTTON
document.getElementById("verifyBtn").addEventListener("click", async () => {
    const otp = document.getElementById("otpInput").value.trim();
    const msg = document.getElementById("msg");

    if(!/^[0-9]{6}$/.test(otp)){
        msg.innerHTML = "❌ Enter a valid 6-digit code";
        msg.style.color = "red";
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/auth/mfa/verify`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ token, otp })
        });

        const data = await res.json();

        if(data.access_token){
            sessionStorage.setItem("access_token", data.access_token);
            msg.innerHTML = "✔ Verified — redirecting...";
            msg.style.color = "green";
            setTimeout(()=> window.location.href="scan.html",700);
        } else {
            msg.innerHTML = "❌ Invalid code. Try again.";
            msg.style.color = "red";
        }
    } catch (err) {
        msg.innerHTML = "⚠ Verification error";
        msg.style.color = "red";
    }
});
</script>
</body>
</html>
